<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>D PhotoBooth</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui, sans-serif;
  background:#111;
  color:#fff;
  display:flex;
  justify-content:center;
}

.app{
  max-width:420px;
  width:100%;
  padding:15px;
}

video{
  width:100%;
  border-radius:14px;
  background:#000;
}

.controls{
  margin-top:10px;
  display:flex;
  gap:10px;
}

button{
  flex:1;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#facc15;
  font-weight:700;
  cursor:pointer;
}

button.secondary{
  background:#333;
  color:#fff;
}

.editor{
  display:none;
  margin-top:15px;
}

canvas{
  width:100%;
  border-radius:14px;
}

/* FLASH */
.flash{
  position:fixed;
  inset:0;
  background:white;
  opacity:0;
  pointer-events:none;
  transition:opacity .15s;
  z-index:999;
}
.flash.active{ opacity:1; }
</style>
</head>
<body>

<div class="app">

  <video id="video" autoplay playsinline></video>

  <div class="controls">
    <button id="startCam">üì∑ Aktifkan Kamera</button>
    <button id="toggleSound" class="secondary">üîä ON</button>
  </div>

  <div class="controls">
    <button id="capture">üì∏ Jepret</button>
  </div>

  <div class="editor">
    <canvas id="editorCanvas"></canvas>
    <div class="controls">
      <button id="download">‚¨áÔ∏è Download</button>
    </div>
  </div>

</div>

<div class="flash" id="flash"></div>

<!-- SOUNDS -->
<audio id="shutterSound" src="https://assets.mixkit.co/sfx/preview/mixkit-camera-shutter-click-1133.mp3"></audio>
<audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3"></audio>

<script>
let stream;
let photos = [];
let editorCanvas;
let soundOn = true;

const video = document.getElementById("video");
const startCam = document.getElementById("startCam");
const capture = document.getElementById("capture");
const editor = document.querySelector(".editor");
const downloadBtn = document.getElementById("download");
const flash = document.getElementById("flash");

const shutterSound = document.getElementById("shutterSound");
const clickSound = document.getElementById("clickSound");
const toggleSound = document.getElementById("toggleSound");

/* SOUND */
function play(sound){
  if(soundOn){
    sound.currentTime = 0;
    sound.play();
  }
}

toggleSound.onclick=()=>{
  soundOn=!soundOn;
  toggleSound.textContent = soundOn ? "üîä ON" : "üîá OFF";
  play(clickSound);
};

/* CAMERA */
startCam.onclick = async()=>{
  play(clickSound);
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"user" }
    });
    video.srcObject = stream;
  }catch(err){
    alert(
      "‚ùå Kamera ditolak\n\n" +
      "Klik ikon üîí di address bar\n" +
      "Ubah Camera ‚Üí Allow\n" +
      "Lalu refresh halaman"
    );
  }
};

/* CAPTURE */
capture.onclick=()=>{
  if(!stream){
    alert("Aktifkan kamera dulu");
    return;
  }

  play(shutterSound);

  flash.classList.add("active");
  setTimeout(()=>flash.classList.remove("active"),150);

  const c=document.createElement("canvas");
  c.width=video.videoWidth;
  c.height=video.videoHeight;
  c.getContext("2d").drawImage(video,0,0);
  photos=[c.toDataURL("image/png")];

  openEditor();
};

/* EDITOR */
function openEditor(){
  editor.style.display="block";

  setTimeout(()=>{
    if(editorCanvas) editorCanvas.dispose();

    editorCanvas = new fabric.Canvas("editorCanvas",{
      preserveObjectStacking:true
    });

    editorCanvas.setWidth(360);
    editorCanvas.setHeight(520);

    /* BACKGROUND (WAJIB DI CANVAS) */
    const gradient = new fabric.Gradient({
      type:"linear",
      coords:{x1:0,y1:0,x2:0,y2:520},
      colorStops:[
        {offset:0,color:"#fce7f3"},
        {offset:1,color:"#e0f2fe"}
      ]
    });

    editorCanvas.setBackgroundColor(
      gradient,
      editorCanvas.renderAll.bind(editorCanvas)
    );

    buildPhoto();
  },50);
}

function buildPhoto(){
  fabric.Image.fromURL(photos[0],img=>{
    img.scaleToWidth(320);
    img.set({
      left:20,
      top:20,
      selectable:false
    });
    editorCanvas.add(img);
    editorCanvas.renderAll();
  },{crossOrigin:"anonymous"});
}

/* DOWNLOAD */
downloadBtn.onclick=()=>{
  play(clickSound);
  const a=document.createElement("a");
  a.download="photobooth.png";
  a.href=editorCanvas.toDataURL({
    format:"png",
    multiplier:2,
    enableRetinaScaling:true
  });
  a.click();
};
</script>

</body>
</html>
